set terminal svg size 1440,900 font "Linux Biolinum,20"
set output "<%= svg.path %>"

set multiplot layout 2,1

set border 11

set xdata time
set timefmt "%Y-%m-%d"
set format x "%Y-%m"
set grid
set lmargin 6

set xrange [ "<%= start_date %>" : "<%= start_date+[optimal_days_to_go,days_to_go].max %>" ]
set yrange [ <%= goal %> : <%= @weights.map{|w| w.weight}.max.ceil %> ]
set ytics 1 nomirror
set mxtics 1
set xtics 2592000 nomirror

set obj 1 rectangle behind from screen 0,0 to screen 1,1
set obj 1 fillstyle solid 1.0 fillcolor rgb "white" linewidth 0

plot "<%= weight_dat.path %>" using 1:2 w points t "Weight" pt 13 ps 0.3 lc rgb "navy", \
"<%= weight_dat.path %>" using 1:3 w l t "" lt 1 lw 2 lc rgb "navy", \
<%= moving_average_at(start_date) %>-<%= rate %>*(x/60/60/24/7-<%= (start_date-Date.parse("1970-01-01"))/7.0 %>) t "<%= (rate).round(1) %> kg/week" lc rgb "forest-green"

unset obj 1

set yrange [ 0 : <%= quantize((start_date..end_date).map{|d| [consumed_at(d), allowed_kcal(d, rates.first)]}.flatten.max) %> ]
set ytics 200 nomirror

plot "<%= input_dat.path %>" using 1:2:(0):($4-$2) w vectors nohead lc rgb "navy" notitle, \
"<%= input_dat.path %>" using 1:2 w points pt 13 ps 0.3 lc rgb "navy" t "Consumed energy", \
"<%= input_dat.path %>" using 1:3 w lines lc rgb "black" t "0 kg/week", \
"<%= input_dat.path %>" using 1:4 w lines lc rgb "forest-green" lw 2 t "<%= rate %> kg/week"

unset multiplot
